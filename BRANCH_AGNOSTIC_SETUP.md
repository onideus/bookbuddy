# Branch-Agnostic Feature Tracking

**Problem**: Your Claude Code client manages worktrees with fixed branch names (e.g., `zachmartin/overseer`, `zachmartin/implementor-a`) that don't follow the `feature/<spec-id>/...` pattern.

**Solution**: Track feature IDs independently of branch names using per-worktree configuration.

---

## 🎯 How It Works

### Priority Order for Feature ID Detection

The automation system checks multiple sources in this order:

1. **`.claude/feature.config`** ← **RECOMMENDED** (highest priority)
2. **Git config** (`feature.specid`)
3. **Branch pattern** (`feature/XXX/...`)
4. **Event store query** (branch-to-feature mapping)

This allows you to use **any branch naming pattern** while still tracking which feature each worktree is working on.

---

## 🚀 Quick Start

### Step 1: Set Feature ID for Each Worktree

```bash
# In overseer worktree
cd /path/to/overseer/worktree
./scripts/orchestrator/set-feature.sh 003-reading-goals

# In implementor-a worktree
cd /path/to/implementor-a/worktree
./scripts/orchestrator/set-feature.sh 003-reading-goals

# In implementor-b worktree
cd /path/to/implementor-b/worktree
./scripts/orchestrator/set-feature.sh 003-reading-goals
```

This creates `.claude/feature.config` in each worktree.

### Step 2: Set Agent Role

```bash
# In each worktree, set the role
echo "overseer" > .claude/agent-role.local
# or: implementor-a, implementor-b, implementor-c
```

### Step 3: Work Normally

```bash
# Commits automatically sync status
git commit -am "[003] Your changes"

# Tools automatically detect feature ID
./scripts/orchestrator/auto-status-sync.sh
```

---

## 📋 Complete Workflow Example

### Scenario: Client Creates These Worktrees

```
~/.claude-squad/worktrees/
├── overseer_1873610797206198/     → branch: zachmartin/overseer
├── implementor_a_1873610797207/   → branch: zachmartin/implementor-a
├── implementor_b_1873610797208/   → branch: zachmartin/implementor-b
└── implementor_c_1873610797209/   → branch: zachmartin/implementor-c
```

### Setup (One-Time Per Feature)

**Overseer:**
```bash
cd ~/.claude-squad/worktrees/overseer_1873610797206198

# Set feature ID
./scripts/orchestrator/set-feature.sh 003-reading-goals

# Set role
echo "overseer" > .claude/agent-role.local

# Register in event store (if not already done)
./scripts/orchestrator/event-store.sh add-feature 003-reading-goals "Reading Goals Tracker"
```

**Implementor-A:**
```bash
cd ~/.claude-squad/worktrees/implementor_a_1873610797207

# Set feature ID
./scripts/orchestrator/set-feature.sh 003-reading-goals

# Set role
echo "implementor-a" > .claude/agent-role.local
```

**Implementor-B & C:** (repeat with their respective roles)

### Daily Use

```bash
# Work in any worktree
cd ~/.claude-squad/worktrees/overseer_1873610797206198

# Make changes
vim src/models/user.js

# Commit (hooks automatically sync)
git commit -am "[003] Implement user model"

# ✓ Auto-detected feature: 003-reading-goals (from .claude/feature.config)
# ✓ Auto-detected role: overseer (from .claude/agent-role.local)
# ✓ Auto-updated: state/overseer.md
```

---

## 🛠️ Management Commands

### View Current Configuration

```bash
./scripts/orchestrator/set-feature.sh
```

Output:
```
==========================================
Current Feature Configuration
==========================================

Branch: zachmartin/overseer
Feature Config (.claude/feature.config):
SPEC_ID=003-reading-goals

Git Config: 003-reading-goals
Event Store: 003-reading-goals
```

### Change Feature

```bash
# Switch to different feature
./scripts/orchestrator/set-feature.sh 004-new-feature
```

### Clear Configuration

```bash
./scripts/orchestrator/set-feature.sh --clear
```

---

## 📁 Configuration Files

### `.claude/feature.config`

**Location**: Per-worktree (gitignored)
**Purpose**: Explicit feature ID declaration
**Format**:
```bash
# Feature configuration for this worktree
# Auto-generated by set-feature.sh
SPEC_ID=003-reading-goals
```

**Precedence**: Highest (overrides everything else)

### `.claude/agent-role.local`

**Location**: Per-worktree (gitignored)
**Purpose**: Declare agent role
**Format**:
```
overseer
```
or: `implementor-a`, `implementor-b`, `implementor-c`

### Git Config (Alternative)

```bash
# Set via git
git config --local feature.specid 003-reading-goals

# View
git config --local feature.specid

# Remove
git config --local --unset feature.specid
```

---

## 🔄 Integration with Existing Tools

### Auto-Status-Sync

**Before**:
- Required `feature/*/...` branch naming
- Failed on custom branch names

**Now**:
- Checks `.claude/feature.config` first
- Works with any branch name
- Falls back to event store if needed

### Claude Orchestrator CLI

**Updated commands**:
```bash
# Still works, but now updates feature.config
./scripts/orchestrator/claude-orchestrator.sh init-feature 003-auth

# Or manually set feature
./scripts/orchestrator/set-feature.sh 003-auth
```

### Event Store

**Synergy**:
- `set-feature.sh` updates event store automatically
- Event store provides fallback if config missing
- Both systems stay in sync

### Conflict Detector

**Updated**:
- Checks all registered branches (regardless of naming)
- Uses event store for branch-to-feature mapping
- Works with custom branch patterns

---

## 🎯 Benefits

### 1. Branch Name Independence

**Before**:
```
feature/003-reading-goals/overseer      ✓ Works
zachmartin/overseer                     ✗ Doesn't work
```

**Now**:
```
feature/003-reading-goals/overseer      ✓ Works (pattern match)
zachmartin/overseer                     ✓ Works (.claude/feature.config)
any-branch-name                         ✓ Works (explicit config)
```

### 2. Client Compatibility

Your `.claude-squad` client can use whatever branch naming it wants. The automation adapts.

### 3. Easy Reconfiguration

Switch features without changing branches:
```bash
# Work on different feature in same worktree
./scripts/orchestrator/set-feature.sh 004-new-feature
git commit -am "[004] New work"
# ✓ Auto-syncs to feature 004
```

### 4. No Code Changes Needed

All existing tools automatically support this via the updated `get_spec_id()` function.

---

## 🔍 Verification

### Test Feature Detection

```bash
# Test auto-status-sync
./scripts/orchestrator/auto-status-sync.sh

# Should show:
# "Syncing status for: overseer"
# "Commit: ... "
# "✓ State file updated"
```

### Test Event Store

```bash
# View feature status
./scripts/orchestrator/event-store.sh status 003-reading-goals

# Should show your branch mapped to the feature
```

### Test Git Hooks

```bash
# Make a commit
git commit --allow-empty -m "[003] Test commit"

# Check logs
cat .orchestrator/logs/git-hooks.log

# Should show successful sync
```

---

## 🐛 Troubleshooting

### "No spec ID found"

**Cause**: No configuration set
**Solution**:
```bash
./scripts/orchestrator/set-feature.sh 003-reading-goals
```

### "Feature not in event store"

**Cause**: Feature not registered
**Solution**:
```bash
./scripts/orchestrator/event-store.sh add-feature 003-reading-goals "Name"
```

### Configuration Out of Sync

**Symptoms**: Different IDs in config vs event store
**Solution**:
```bash
# Re-run set-feature to sync everything
./scripts/orchestrator/set-feature.sh 003-reading-goals
```

---

## 📚 Migration Guide

### From Branch-Based Tracking

**Old workflow**:
1. Use `feature/XXX/...` branch names
2. Tools extract spec ID from branch
3. ✗ Breaks with custom branch names

**New workflow**:
1. Use any branch names
2. Explicitly set feature ID per worktree
3. ✓ Works universally

**Migration steps**:
```bash
# For each worktree
cd /path/to/worktree

# Set feature ID once
./scripts/orchestrator/set-feature.sh <current-feature>

# Set role once
echo "<role>" > .claude/agent-role.local

# Done! Tools now work regardless of branch name
```

---

## 🚀 Best Practices

### 1. Set Configuration Early

When starting work on a new feature:
```bash
./scripts/orchestrator/set-feature.sh 004-new-feature
echo "overseer" > .claude/agent-role.local
```

### 2. Keep Event Store Updated

After setting feature config:
```bash
./scripts/orchestrator/event-store.sh add-feature 004-new-feature "Feature Name"
```

### 3. Verify Configuration

Before major work:
```bash
./scripts/orchestrator/set-feature.sh  # Show current config
```

### 4. One Feature Per Worktree

Each worktree should work on one feature at a time. If switching features, update configuration:
```bash
./scripts/orchestrator/set-feature.sh 005-different-feature
```

---

## 📊 Summary

| Aspect | Old System | New System |
|--------|-----------|------------|
| Branch naming | `feature/XXX/...` required | **Any name works** |
| Configuration | Implicit (from branch) | **Explicit (per-worktree)** |
| Client compatibility | Limited | **Universal** |
| Flexibility | Low | **High** |
| Setup complexity | None | **Minimal (one command)** |

---

## 🎉 Result

Your `.claude-squad` client can now use **any branch naming scheme**, and the automation will work perfectly. Just set `.claude/feature.config` once per worktree, and everything else is automatic!

**Command to remember**:
```bash
./scripts/orchestrator/set-feature.sh <spec-id>
```

That's it! 🚀
