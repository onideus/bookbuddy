# Implementation Plan: Book Information Search

**Branch**: `002-book-api-search` | **Date**: 2025-10-29 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-book-api-search/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command following comprehensive GPT-5 (Codex) architectural review and approval of all critical decisions.

## Summary

Integrate external book API (Google Books primary, Open Library fallback) to enable users to search for books by title, author, or ISBN and auto-populate book metadata, reducing manual entry time by 60%. Architecture includes per-user metadata overrides to prevent data leakage, multi-layer caching (Redis 12h + PostgreSQL 30 days) for performance, circuit breaker pattern for resilience, and ISBN-first duplicate detection with fuzzy matching fallback. Expected traffic: <10 concurrent users, ~100 searches/day.

## Technical Context

**Language/Version**: JavaScript ES2022+, Node.js 20+ LTS
**Primary Dependencies**: Fastify (web framework), ioredis (Redis client), opossum (circuit breaker), axios/got (HTTP client with retry), fuzzball/string-similarity (fuzzy matching)
**Storage**: PostgreSQL (existing) + Redis (Docker Compose orchestrated) + pg_trgm extension for fuzzy text search
**Testing**: Vitest (unit), Polly.js/nock (HTTP recording for integration), Playwright (E2E), contract tests against live API (nightly)
**Target Platform**: Linux server (Docker containerized), accessed via web browser
**Project Type**: Web application (backend API + frontend UI)
**Performance Goals**: 90% of searches return within 3 seconds, cache hit rate >70%, handle 10 concurrent users
**Constraints**: <3s response time (p90), Google Books free tier (1,000 req/day), 2-3s upstream timeout, graceful degradation on failures
**Scale/Scope**: <10 concurrent users, ~100 searches/day (3,000/month), support personal libraries up to 5,000 books

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-checked after Phase 1 design.*

Verify compliance with BookBuddy Constitution (v1.0.0):

- [x] **Code Quality**: Provider abstraction promotes single responsibility; per-user overrides minimize coupling; dependencies (ioredis, opossum, axios, fuzzball) are justified for caching, resilience, HTTP, and duplicate detection
- [x] **Testing Standards**: TDD approach planned with red-green-refactor cycle; ≥90% coverage target; tests map to acceptance scenarios; VCR/cassette recordings for deterministic integration tests
- [x] **UX Consistency**: Loading states for API calls; accessible search interface (keyboard navigation, WCAG 2.1 AA); error messages are actionable ("Search temporarily offline, use manual entry"); responsive design for mobile/tablet/desktop
- [x] **Performance**: <3s response time target (SC-002); caching strategy enables targets within free tier limits; circuit breaker prevents cascading failures; optimistic UI updates for perceived performance
- [x] **Observability**: Structured logging for search queries, API calls, cache hits/misses, circuit breaker state; metrics for provider latency (p50/p95/p99), quota usage, duplicate detection accuracy; health check for Redis and external APIs

**Complexity Justification**: None - all dependencies and patterns are justified by requirements.

## Project Structure

### Documentation (this feature)

```text
specs/001-book-api-search/
├── spec.md                    # Feature specification (completed)
├── CODEX_ARCHITECTURAL_REVIEW.md  # GPT-5 architectural review (completed)
├── plan.md                    # This file (/speckit.plan command output)
├── research.md                # Phase 0 output (/speckit.plan command)
├── data-model.md              # Phase 1 output (/speckit.plan command)
├── quickstart.md              # Phase 1 output (/speckit.plan command)
├── contracts/                 # Phase 1 output (/speckit.plan command)
│   ├── book-search-api.yaml   # OpenAPI spec for search endpoints
│   └── examples/              # Example requests/responses
├── checklists/
│   └── requirements.md        # Spec quality checklist (completed)
└── tasks.md                   # Phase 2 output (/speckit.tasks command - NOT YET CREATED)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── models/
│   │   ├── book.js                # Existing model (will be extended)
│   │   ├── book-edition.js        # NEW: Edition-specific data (ISBN, format)
│   │   ├── book-metadata-source.js # NEW: Provenance tracking
│   │   ├── reading-entry-override.js # NEW: Per-user metadata overrides
│   │   └── book-search-cache.js   # NEW: PostgreSQL L2 cache
│   ├── services/
│   │   ├── book-search/
│   │   │   ├── index.js           # NEW: Main search service
│   │   │   ├── providers/
│   │   │   │   ├── base-provider.js  # NEW: Abstract provider interface
│   │   │   │   ├── google-books.js   # NEW: Google Books integration
│   │   │   │   └── open-library.js   # NEW: Open Library fallback
│   │   │   ├── cache-manager.js   # NEW: Multi-layer caching (Redis L1 + PG L2)
│   │   │   ├── circuit-breaker.js # NEW: Resilience wrapper
│   │   │   ├── duplicate-detector.js # NEW: ISBN-first + fuzzy matching
│   │   │   └── normalizer.js      # NEW: Provider response normalization
│   │   └── redis-client.js        # NEW: Redis connection management
│   ├── api/
│   │   └── routes/
│   │       └── book-search.js     # NEW: Search endpoints (GET /api/books/search)
│   └── lib/
│       └── metrics.js             # EXTEND: Add search metrics
├── migrations/
│   └── 003_book_search_tables.sql # NEW: book_editions, book_metadata_sources, etc.
└── tests/
    ├── unit/
    │   ├── services/book-search/
    │   │   ├── providers/
    │   │   │   ├── google-books.test.js
    │   │   │   └── open-library.test.js
    │   │   ├── cache-manager.test.js
    │   │   ├── duplicate-detector.test.js
    │   │   └── normalizer.test.js
    │   └── models/
    │       ├── book-edition.test.js
    │       └── book-metadata-source.test.js
    ├── integration/
    │   ├── book-search-flow.test.js  # Search → select → save flow
    │   └── fixtures/
    │       └── cassettes/            # Polly.js HTTP recordings
    ├── contract/
    │   └── google-books-api.test.js  # Nightly tests against live API
    └── e2e/
        └── book-search.spec.js       # Playwright E2E tests

frontend/
├── src/
│   ├── components/
│   │   ├── BookSearch/
│   │   │   ├── SearchInput.jsx        # NEW: Search form component
│   │   │   ├── SearchResults.jsx      # NEW: Results list
│   │   │   ├── BookResultCard.jsx     # NEW: Individual result display
│   │   │   └── SearchFilters.jsx      # NEW: Year/author filters (P2)
│   │   └── BookForm/
│   │       └── [EXTEND existing AddBookForm to integrate search]
│   ├── services/
│   │   └── bookSearchApi.js           # NEW: API client for search
│   └── hooks/
│       └── useBookSearch.js           # NEW: React hook for search state
└── tests/
    └── components/
        └── BookSearch.test.jsx

docker-compose.yml                    # EXTEND: Add Redis service
```

**Structure Decision**: Web application (Option 2) - existing backend/frontend structure. New book search functionality integrates with existing book models and extends the current add-book flow.

## Complexity Tracking

> **No violations** - all architectural decisions align with constitution principles.

## Phase 0: Research & Technical Decisions

**Prerequisites**: Constitution Check passed ✓

### Research Topics

1. **Provider Selection & Integration**
   - Evaluate Google Books API vs. Open Library API characteristics
   - Determine request/response formats, rate limits, error handling
   - Identify best practices for provider abstraction patterns

2. **Caching Strategy**
   - Redis TTL management for low-traffic scenario
   - PostgreSQL cache table design for 30-day retention
   - Cache stampede protection patterns
   - Graceful degradation when Redis unavailable

3. **Circuit Breaker Implementation**
   - Opossum library configuration (thresholds, timeouts, fallback behavior)
   - Circuit breaker state transitions (closed → open → half-open)
   - Integration with caching layer for fallback

4. **Duplicate Detection Algorithms**
   - ISBN-13 vs ISBN-10 normalization
   - Fuzzy string matching for title+author (Levenshtein distance, trigram similarity)
   - PostgreSQL pg_trgm extension setup and performance

5. **Testing Strategies**
   - Polly.js vs nock for HTTP recording
   - Cassette refresh strategies to avoid drift
   - Contract test design against live APIs without quota exhaustion

**Output**: [research.md](./research.md) - to be generated

## Phase 1: Design & Architecture

**Prerequisites**: Phase 0 research completed

### Data Model Design

**Output**: [data-model.md](./data-model.md)

Entities to define:
1. **Book** (existing, extend): Add normalized_title, primary_author, language, categories fields
2. **BookEdition** (new): ISBN-10, ISBN-13, edition, format, cover_image_url, provider_id
3. **BookMetadataSource** (new): Provenance tracking - provider, fetched_at, etag, raw_payload (JSONB)
4. **ReadingEntryOverride** (new): Per-user field overrides - reading_entry_id, field_name, override_value
5. **BookSearchCache** (new): Cached search results - search_key, provider, results (JSONB), expires_at

Relationships:
- Book 1:N BookEdition
- BookEdition 1:N BookMetadataSource
- ReadingEntry 1:N ReadingEntryOverride
- BookSearchCache independent (query cache)

### API Contracts

**Output**: [contracts/book-search-api.yaml](./contracts/book-search-api.yaml)

Endpoints to define:
- `GET /api/books/search` - Search books by query, type (title/author/isbn)
- `GET /api/books/search/results/:id` - Get details of specific search result
- `POST /api/books/from-search` - Create book entry from search result
- `POST /api/books/:bookId/refresh-metadata` - Refresh metadata from provider (P2)

Request/Response schemas:
- SearchQuery: `{ query: string, type: 'title'|'author'|'isbn', filters?: { yearRange, author } }`
- SearchResult: `{ id, title, author, isbn, publisher, publicationDate, pageCount, description, coverImageUrl, provider }`
- SearchResponse: `{ results: SearchResult[], totalCount, cacheHit: boolean, provider }`

### Developer Quickstart

**Output**: [quickstart.md](./quickstart.md)

Sections:
1. **Setup**: Docker Compose up (Redis), run migration 003, install npm dependencies
2. **Environment Variables**: GOOGLE_BOOKS_API_KEY (optional for higher quota), REDIS_URL
3. **Run Tests**: Unit, integration, contract tests with instructions
4. **Local Development**: Start backend/frontend, test search flow
5. **Troubleshooting**: Common issues (Redis not running, API key issues, cache misses)

## Phase 1: Agent Context Update

After completing data-model.md, contracts/, and quickstart.md:

```bash
.specify/scripts/bash/update-agent-context.sh claude
```

This updates `.claude/CLAUDE.md` with new technologies:
- Redis (ioredis)
- Circuit Breaker (opossum)
- HTTP recording (Polly.js)
- Fuzzy matching (fuzzball)
- Google Books API
- Open Library API

## Architecture Decisions (from Codex Review)

**Recorded for implementation reference:**

### API Provider Strategy
- **Primary**: Google Books API (richest metadata, $0/month free tier sufficient)
- **Fallback**: Open Library API (no rate limits, historical coverage)
- **Pattern**: Provider abstraction layer (query + normalize + hydrate interface)

### Data Model
- **Canonical books**: Immutable work-level metadata (shared across users)
- **Per-user overrides**: reading_entries_overrides table (prevents data leakage)
- **Provenance tracking**: book_metadata_sources table (audit trail for SC-007)

### Caching
- **Redis (L1)**: 12-hour TTL, stampede protection
- **PostgreSQL (L2)**: 30-day TTL, survives restarts
- **HTTP Cache**: Respect ETags, If-None-Match

### Resilience
1. **Timeouts**: 2-3 seconds (not 10s) with graceful degradation
2. **Circuit Breaker**: Open on 5 failures/60s, fallback to cache/manual
3. **Retry**: Exponential backoff, max 2 retries
4. **Throttling**: 10 searches/min per user

### Duplicate Detection
- **Primary**: ISBN-based (most accurate)
- **Fallback**: Normalized title+primary_author+year with pg_trgm fuzzy matching
- **Threshold**: 0.8 similarity score for matches

## Implementation Phases

### Phase 1 - MVP (Current)
- Google Books integration with provider abstraction
- Redis + PostgreSQL caching
- Per-user overrides (prevent data leakage)
- Circuit breaker + 2-3s timeouts
- ISBN-based duplicate detection
- Provenance tracking (metadata_sources table)

### Phase 2 - Enhancements (Future)
- Open Library fallback integration
- Advanced fuzzy duplicate detection (pg_trgm)
- Search filters (year range, author refinement)
- Cover image proxy/cache
- Admin tools for metadata management

### Phase 3 - Optimization (Future)
- Additional API providers
- Machine learning for duplicate detection
- Advanced caching strategies
- Performance optimizations

## Success Criteria Mapping

Implementation must achieve:

**User Experience**:
- SC-001: Book addition in <30 seconds (via fast API + caching)
- SC-002: 90% of searches <3 seconds (via Redis L1 cache + 2-3s timeout)
- SC-003: 85% first-attempt success (via clear UX + fallback to manual)
- SC-004: 60% manual entry time reduction (via auto-populated fields)
- SC-006: 4.5/5 user satisfaction (via responsive UI + helpful error messages)

**Performance & Reliability**:
- SC-005: 10 concurrent users (via caching + free tier quota management)
- SC-008: 70% cache hit rate (via 12h Redis + 30-day PostgreSQL TTL)
- SC-009: Circuit breaker <1% false positives (via opossum configuration tuning)

**Data Quality**:
- SC-007: 95% accuracy (via provenance tracking in metadata_sources table)
- SC-010: 95% duplicate detection (via ISBN-first + fuzzy matching fallback)

## Risks & Mitigation (from Spec)

| Risk | Status | Mitigation |
|------|--------|------------|
| Data leakage from shared books table | ✅ **APPROVED** | Per-user overrides (FR-015) |
| Rate limit exhaustion | ✅ **RESOLVED** | Free tier sufficient + caching |
| Duplicate books allowed | ✅ **APPROVED** | ISBN-first + fuzzy (FR-019) |
| No provenance for accuracy audit | ✅ **APPROVED** | Metadata sources table (FR-020) |
| 10s timeout violates SC-002 | ✅ **APPROVED** | 2-3s timeout + circuit breaker |
| Cover image URLs break | ✅ **APPROVED** | Hot-link MVP, proxy Phase 2 |
| Provider API breaking changes | Monitoring required | Contract tests + abstraction |
| Redis unavailability | Circuit breaker | Graceful degradation to PG L2 |

## Next Steps

1. ✅ **Phase 0 Complete**: Generate research.md
2. ✅ **Phase 1 Complete**: Generate data-model.md, contracts/, quickstart.md
3. ✅ **Agent Context Updated**: Claude context includes new technologies
4. **→ Phase 2**: Run `/speckit.tasks` to generate tasks.md with implementation tasks ordered by user story priority
5. **→ Implementation**: Run `/speckit.implement` to execute tasks

---

**Plan Status**: ✅ **READY FOR TASK GENERATION**
**Command**: `/speckit.plan` completed successfully
**Date**: 2025-10-29
